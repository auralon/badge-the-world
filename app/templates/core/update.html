{% extends "layout.html" %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
{% endblock %}

{% block header %}
<h1>I will badge the world.</h1>
{% endblock %}

{% block body %}
<div class="container">
	{% if user %}
		<p>Pledge your support for Badge the World! Badge the World is the new social and technology movement to capture recognition for learning that happens anywhere.</p>
		<p><span class="required">*Required</span></p>

		<form action="/updatePledge" method="post" accept-charset="utf-8">
			<input type="hidden" name="_csrf" value="{{ csrfToken }}">
			<input type="hidden" name="id" value="{{ pledge.uid }}">
			<input type="hidden" name="lat" value="{{ pledge.lat }}">
			<input type="hidden" name="lon" value="{{ pledge.lon }}">
			<h2>5 ways to pledge to become a Badge partner:</h2>
			<ul>
				<li><input type="checkbox" name="createBadge" value="Create or Design Badges" id="createBadge" role="checkbox" {% if pledge.fiveWays.match('Create or Design Badges') %}checked{% endif %}>Create or Design Badges</li>
				<li><input type="checkbox" name="issueBadge" value="Issue Badges" id="issueBadge" role="checkbox" {% if pledge.fiveWays.match('Issue Badges') %}checked{% endif %}>Issue Badges</li>
				<li><input type="checkbox" name="displayBadge" value="Display Badges" id="displayBadge" role="checkbox" {% if pledge.fiveWays.match('Display Badges') %}checked{% endif %}>Display Badges</li>
				<li><input type="checkbox" name="researchBadge" value="Research Badges" id="researchBadge" role="checkbox" {% if pledge.fiveWays.match('Research Badges') %}checked{% endif %}>Research Badges</li>
				<li><input type="checkbox" name="joinBadge" value="Join the Badging Conversation" id="joinBadge" role="checkbox" {% if pledge.fiveWays.match('Join the Badging Conversation') %}checked{% endif %}>Join the Badging Conversation</li>
			</ul>

			<h2>Tell us about your badging ideas... <span class="required">*</span></h2>
			<textarea name="idea" rows="8" cols="55" class="required" id="idea" dir="auto" aria-label="Tell us about your badging ideas...  " aria-required="true" required="">{{ pledge.idea }}</textarea>

			<h2>How many people will your badging efforts impact? <span class"required">*</span></h2>
			<p class="sub">Be ambitious...</p>
			<input type="text" name="numberOfPeople" value="{{ pledge.numberOfPeople }}" class="required" id="numberOfPeople" dir="auto" aria-label="How many people will your badging efforts impact? Be ambitious... " aria-required="true" required="" title="">

			<h2>Address:</h2>
			<p class"sub">Where will this happen?</p>
			<input type="text" name="address" value="{{ pledge.location }}" id="address" dir="auto" aria-label="Location: Where will this happen? " aria-required="true" title="">

			<button id="update">Search</button>

			<p>You can click the marker to drag its position.</p>
			<div id="map-container"></div>

			<a name="map" href="#"></a>

			<h2>Email address</h2>
			<input type="email" name="email" value="{{ pledge.email }}" id="email" dir="auto" aria-label="Email address " aria-required="true" title="">

			<h2>Your name</h2>
			<input type="text" name="name" value="{{ pledge.name }}" id="name" dir="auto" aria-label="Your name " aria-required="true" title="">

			<h2>Your twitter handle</h2>
			<input type="text" name="twitterHandle" value="{{ pledge.twitterHandle }}" id="twitterHandle" dir="auto" aria-label="Your twitter handle " aria-required="true" title="">

			<h2>Organization</h2>
			<input type="text" name="organisation" value="{{ pledge.organisation }}" id="organisation" dir="auto" aria-label="Organisation " aria-required="true" title="">

			<h2>Share...</h2>
			<ul>
				<li><input type="checkbox" name="shareCaseStyudy" value="Share case study" id="shareCaseStyudy" role="checkbox" {% if pledge.share and pledge.share.match('Share case study') %}checked{% endif %}>Share case study</li>
				<li><input type="checkbox" name="shareOB" value="Share OB with your network" id="shareOB" role="checkbox" {% if pledge.share and pledge.share.match('Share OB with your network') %}checked{% endif %}>Share OB with your network</li>
			</ul>

			<p>
				<input type="checkbox" name="subscribe" value="Subscribe" id="subscribe" role="checkbox" {% if pledge.subscribe == false %}checked{% endif %}>I don't want to receive updates from Badge The World
			</p>

			<p>
				<input type="submit" name="submit" value="Submit" id="submit">
			</p>
		</form>
	{% endif %}
</div>
{% endblock %}

{% block scripts %}
	{% if user %}
		<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
		<script type="text/javascript">
			$(function() {
				$('#update').on('click', function(e) {
					e.preventDefault();

					var $button = $(this);

					$button.hide();
					$button.text('Search');

					var address = encodeURIComponent($('#address').val());
					var url = 'http://nominatim.openstreetmap.org/search?q=' + address + '&format=json';

					$.get(url, function(response) {
						if (typeof response[0] !== "undefined") {

							$(body).animate({scrollTop: $(body).height()},'slow');
							$button.show();

							var lon = response[0].lon;
							var lat = response[0].lat;

							setCoordinates(lat, lon);

							$('#map').remove();
							$('<div id="map" style="height: 300px"></div>').appendTo($('#map-container'));

							var map = L.map('map').setView([lat, lon], 13);

							L.tileLayer('http://{s}.tiles.mapbox.com/v3/echristensen.map-77cfk1ql/{z}/{x}/{y}.png', {
							    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
							    maxZoom: 18
							}).addTo(map);

							var marker = new L.marker([lat, lon], {draggable:'true'});
						    marker.on('dragend', function(event){
						            var marker = event.target;
						            var position = marker.getLatLng();
						            setCoordinates(position.lat, position.lng);
						    });
						    map.addLayer(marker);

						} else {
							alert("Could not find that address");
							$button.show();
						}
					});
				});

				var setCoordinates = function(lat, lon) {
					$('input[name="lat"]').val(lat);
					$('input[name="lon"]').val(lon);
				}

				$('#update').trigger('click');
			});
		</script>
	{% endif %}
{% endblock %}
