{% extends "layout.html" %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
{% endblock %}

{% block header %}
<h1>I will badge the world.</h1>
{% endblock %}

{% block body %}
<div class="container">
	<p>Pledge your support for Badge the World! Badge the World is the new social and technology movement to capture recognition for learning that happens anywhere.</p>
	<p><span class="required">*Required</span></p>

	<form action="/createPledge" method="post" accept-charset="utf-8">
		<input type="hidden" name="_csrf" value="{{ csrfToken }}">
		<input type="hidden" name="lat" value="">
		<input type="hidden" name="lon" value="">
		<h2>5 ways to pledge to become a Badge partner:</h2>
		<ul>
			<li><input type="checkbox" name="createBadge" value="Create or Design Badges" id="createBadge" role="checkbox">Create or Design Badges</li>
			<li><input type="checkbox" name="issueBadge" value="Issue Badges" id="issueBadge" role="checkbox">Issue Badges</li>
			<li><input type="checkbox" name="displayBadge" value="Display Badges" id="displayBadge" role="checkbox">Display Badges</li>
			<li><input type="checkbox" name="researchBadge" value="Research Badges" id="researchBadge" role="checkbox">Research Badges</li>
			<li><input type="checkbox" name="joinBadge" value="Join the Badging Conversation" id="joinBadge" role="checkbox">Join the Badging Conversation</li>
		</ul>

		<h2>Tell us about your badging ideas... <span class="required">*</span></h2>
		<textarea name="idea" rows="8" cols="55" class="required" id="idea" dir="auto" aria-label="Tell us about your badging ideas...  " aria-required="true" required=""></textarea>

		<h2>How many people will your badging efforts impact? <span class"required">*</span></h2>
		<p class="sub">Be ambitious...</p>
		<input type="text" name="numberOfPeople" value="" class="required" id="numberOfPeople" dir="auto" aria-label="How many people will your badging efforts impact? Be ambitious... " aria-required="true" required="" title="">

		<h2>Address:</h2>
		<p class"sub">Where will this happen?</p>
		<input type="text" name="address" value="" id="address" dir="auto" aria-label="Location: Where will this happen? " aria-required="true" title="">

		<button id="continue1">Continue</button>

		<div id="hidden1" style="display: none">
			<p>You can click the marker to drag its position.</p>
			<div id="map-container"></div>
			<p>If you are happy with the pinned location, then click continue to proceed</p>
			<button id="continue2">Continue</button>
		</div>

		<a name="map" href="#"></a>

		<div id="hidden2" style="display: none">
			<h2>Email address</h2>
			<input type="email" name="email" value="" id="email" dir="auto" aria-label="Email address " aria-required="true" title="">

			<h2>Your name</h2>
			<input type="text" name="name" value="" id="name" dir="auto" aria-label="Your name " aria-required="true" title="">

			<h2>Your twitter handle</h2>
			<input type="text" name="twitterHandle" value="" id="twitterHandle" dir="auto" aria-label="Your twitter handle " aria-required="true" title="">

			<h2>Organization</h2>
			<input type="text" name="organisation" value="" id="organisation" dir="auto" aria-label="Organisation " aria-required="true" title="">

			<h2>Share...</h2>
			<ul>
				<li><input type="checkbox" name="shareCaseStyudy" value="Share case study" id="shareCaseStyudy" role="checkbox">Share case study</li>
				<li><input type="checkbox" name="shareOB" value="Share OB with your network" id="shareOB" role="checkbox">Share OB with your network</li>
			</ul>

			<p>
				<input type="checkbox" name="subscribe" value="Subscribe" id="subscribe" role="checkbox">I don't want to receive updates from Badge The World
			</p>

			<p>
				<input type="submit" name="submit" value="Submit" id="submit">
			</p>
		</div>
	</form>
</div>
{% endblock %}

{% block scripts %}
	<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
	<script type="text/javascript">
		$(function() {
			$('#continue1').on('click', function(e) {
				e.preventDefault();

				var $button = $(this);

				$button.hide();
				$button.text('Update Address');

				var address = encodeURIComponent($('#address').val());
				var url = 'http://nominatim.openstreetmap.org/search?q=' + address + '&format=json';

				$.get(url, function(response) {
					if (typeof response[0] !== "undefined") {

						$('#hidden1').fadeIn(function() {
							$(body).animate({scrollTop: $(body).height()},'slow');
							$button.show();
						});

						var lon = response[0].lon;
						var lat = response[0].lat;

						setCoordinates(lat, lon);

						$('#map').remove();
						$('<div id="map" style="height: 300px"></div>').appendTo($('#map-container'));

						var map = L.map('map').setView([lat, lon], 13);

						L.tileLayer('http://{s}.tiles.mapbox.com/v3/echristensen.map-77cfk1ql/{z}/{x}/{y}.png', {
						    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
						    maxZoom: 18
						}).addTo(map);

						var marker = new L.marker([lat, lon], {draggable:'true'});
					    marker.on('dragend', function(event){
					            var marker = event.target;
					            var position = marker.getLatLng();
					            setCoordinates(position.lat, position.lng);
					            // marker.setLatLng([position],{draggable:'true'}).bindPopup(position).update();
					    });
					    map.addLayer(marker);

					} else {
						alert("Could not find that address");
						$button.show();
					}
				});
			});
			$('#continue2').on('click', function(e) {
				e.preventDefault();
				$(this).hide();
				$('#hidden2').fadeIn();
			});

			var setCoordinates = function(lat, lon) {
				$('input[name="lat"]').val(lat);
				$('input[name="lon"]').val(lon);
			}
		});
	</script>
{% endblock %}
